<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>Pyramid advanced configuration tactics for nice apps and libs</title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><meta name="author" content="Georges Dubus"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="europython.css" media="screen,projection"></link></head><body class="impress-not-supported"><div id="impress"><div class="step" step="0" data-x="0" data-y="0"><h1 id="pyramid-advanced-configuration-tactics-for-nice-apps-and-libs">Pyramid advanced configuration tactics for nice apps and libs</h1><h2 id="europython-2013">Europython 2013</h2></div><div class="step" step="1" data-x="1600" data-y="0"><h1 id="hi-i-m-georges">Hi, I'm Georges</h1></div><div class="step" step="2" data-x="3200" data-y="0"><h1 id="quick-question">Quick question</h1></div><div class="step" step="3" data-x="4800" data-y="0"><h1 id="what-s-pyramid-again">What's pyramid again ?</h1><p>Web framework</p><ul><li>Simplicity</li><li>Minimalism</li><li>Documentation</li><li>Speed</li><li>Reliability</li><li>Openness</li></ul><div class="notes"><p>Here are the keywords from pyramid introduction</p><p>Minimalism : the mapping of URLs to code, templating, security and
serving static assets</p></div></div><div class="step" step="4" data-x="6400" data-y="0"><p>Once upon a time ...</p><p>Persona is the awesome web authentication system by Mozilla that will
save us all.</p><img src="persona_sign_in_blue.png" alt="" width="" height=""></img><p>Using it requires to add some javascript to your page and
to implement a few stuff on server side.</p><p>I included it in a few apps</p><p>Then, I made a library to do that in Pyramid : pyramid_persona.</p><div class="notes"><p>Holger talked about it.</p></div></div><div class="step" step="5" data-x="8000" data-y="0"><h1 id="what-i-m-going-to-talk-about">What I'm going to talk about</h1><ul><li>The extensible configuration  system of Pyramid</li><li>How to use it to make libraries, and nicely organized applications</li></ul><div class="notes"><p>The result is a nice, easy to use library, because pyramid is
well-designed for extensions</p><p>There was a few non-trivial stuff, and a some of research involved.</p><p>2 parts</p><ul><li>In the first, I'll introduce you to the configuration system so
you get an idea of what we are dealing with.</li><li>In the second part, I'll show how to use it for extensions and
organizing apps.</li></ul></div></div><div class="step" step="6" data-x="9600" data-y="0"><h1 id="hello-world">Hello World</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'Whoa there!'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'home'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span></pre><div class="notes"><p>Here is a basic application. The part that's going to interest us
is in the bottom.</p></div></div><div class="step" step="7" data-x="11200" data-y="0"><h1 id="meet-the-configurator">Meet the configurator</h1><p><tt>pyramid.config.Configurator</tt></p><pre class="highlight code python"><span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'home'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre><p>That where you configure everything: views, authentication, renderers, session, &#x2026;</p><p>Its methods are called directives.</p><div class="notes"><p>The configurator is used in every pyramid application, the put
together all the bits</p></div></div><div class="step" step="8" data-x="12800" data-y="0"><p>The order of the directives is not significant. They're just added to
a pending list that is treated on commit.</p><pre class="highlight code python"><span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span> <span class="c"># moved this up</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'home'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre><div class="notes"><p>You can move directives around, the order doesn't matter.</p><p>Everything is resolved when the config is committed. make_wsgi_app
does a commit.</p></div></div><div class="step" step="9" data-x="14400" data-y="0"><p>Decorators with no import-time effects</p><pre class="highlight code python"><span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'Halt!  Who goes there?'</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'home'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span></pre></div><div class="step" step="10" data-x="0" data-y="2000"><h1 id="sanity-checks">Sanity checks</h1><p>The configurator checks that you didn't mess up.</p><pre class="highlight code python"><span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span>
<span class="c"># config.add_route('home', '/')</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre><pre class="highlight ">pyramid.exceptions.ConfigurationExecutionError:
No route named home found for view registration
  in:
    Line 10 of file app.py:
      config.add_view(hello_world, route_name='home')</pre><div class="notes"><p>Here, we try to add a view to a route that does not exists. When we
commit, the configurator will tell us "nope, you can't".</p><p>This is done for a lot of others directives, like authorization
that require authentication.</p></div></div><div class="step" step="11" data-x="1600" data-y="2000"><p>The configurator checks for conflicts. It doesn't let you overwrite by
accident.</p><pre class="highlight code python"><span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'home'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hi_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span> <span class="c"># added</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre><pre class="highlight ">pyramid.exceptions.ConfigurationConflictError:
Conflicting configuration actions
For: ('view', None, '', 'home', 'd41d8cd98f00b204e9800998ecf8427e')
  Line 14 of file app.py:
      config.add_view(hello_world, route_name='home')
  Line 15 of file app.py:
      config.add_view(hi_world, route_name='home')</pre><div class="notes"><p>We try to define two conflicting views, the configurator detects
it, and doesn't silently discard one.</p></div></div><div class="step" step="12" data-x="0" data-y="2800"><h1 id="modular-configuration-include">Modular configuration: include</h1><pre class="highlight code python"><span class="k">def</span> <span class="nf">moreconfiguration</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'goodbye'</span><span class="p">,</span> <span class="s">'/goodbye'</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">goodbye</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'goodbye'</span><span class="p">)</span>


<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'home'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'home'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">moreconfiguration</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre><div class="notes"><p>It is possible to include a callable. It looks like a simple
function call, but there is a few differences.</p></div></div><div class="step" step="13" data-x="1600" data-y="2800"><p>Not a simple function call</p><pre class="highlight code python"><span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">moreconfiguration</span><span class="p">,</span> <span class="n">route_prefix</span><span class="o">=</span><span class="s">'/other'</span><span class="p">)</span></pre><div class="notes"><p>All the routes defined in moreconfiguration will have the prefix.</p></div></div><div class="step" step="14" data-x="3200" data-y="2800"><p>Really not a simple function call: solving conflicts</p><pre class="highlight code python"><span class="k">def</span> <span class="nf">moreconfiguration</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'/hello'</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hello_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">)</span>


<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">hi_world</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">)</span>  <span class="c"># This directives wins</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">moreconfiguration</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre><div class="notes"><p>Top level is more important than what's included. Top level
overrides the rest.</p></div></div><div class="step" step="15" data-x="4800" data-y="2800"><p>It means you have a way to solve conflicts between libraries</p><pre class="highlight code python"><span class="k">def</span> <span class="nf">some_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">some_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">more_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">some_other_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">)</span>


<span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'hello'</span><span class="p">,</span> <span class="s">'/hello'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">some_config</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">more_config</span><span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">some_view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span></pre></div><div class="step" step="16" data-x="0" data-y="3600"><h1 id="the-includeme-convention">The includeme convention</h1><pre class="highlight code python"><span class="kn">import</span> <span class="nn">pyramid_awesomeness</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">pyramid_awesomeness</span><span class="o">.</span><span class="n">includeme</span><span class="p">)</span></pre><p>Is equivalent to</p><pre class="highlight code python"><span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">'pyramid_awesomeness.includeme'</span><span class="p">)</span></pre><p>Also equivalent to</p><pre class="highlight code python"><span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">'pyramid_awesomeness'</span><span class="p">)</span></pre><ul><li>include can be used on dotted names.</li><li>If we include a module, pyramid looks for the includeme function in it.</li></ul><div class="notes"><p>This means we can include a package without worrying on what's inside.</p></div></div><div class="step" step="17" data-x="1600" data-y="3600"><h1 id="python-package-includeme-function-pyramid-extension">python package + includeme function = pyramid extension</h1><ul><li>Extensions can do everything that is possible in pyramid</li><li>Extensions can set default that can be overriden</li></ul></div><div class="step" step="18" data-x="3200" data-y="3600"><p>Example: pyramid_persona sets some default
authentication/authorization policy</p><pre class="highlight code python"><span class="c"># in pyramid_persona</span>
<span class="k">def</span> <span class="nf">includeme</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">authz_policy</span> <span class="o">=</span> <span class="n">ACLAuthorizationPolicy</span><span class="p">()</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authorization_policy</span><span class="p">(</span><span class="n">authz_policy</span><span class="p">)</span>
    <span class="n">secret</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'persona.secret'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span><span class="n">secret</span><span class="p">,</span> <span class="n">hashalg</span><span class="o">=</span><span class="s">'sha512'</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span></pre><p>Easily overriden</p><pre class="highlight code python"><span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">'pyramid_persona'</span><span class="p">)</span>
<span class="n">authn_policy</span> <span class="o">=</span> <span class="n">AuthTktAuthenticationPolicy</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s">'persona.secret'</span><span class="p">],</span>
                                           <span class="n">hashalg</span><span class="o">=</span><span class="s">'sha512'</span><span class="p">,</span>
                                           <span class="n">max_age</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_authentication_policy</span><span class="p">(</span><span class="n">authn_policy</span><span class="p">)</span></pre><div class="notes"><p>For example, pyramid_persona defines some default authentication
and authorization policy, for the convenience.</p><p>I might want to use another one, or the same one with different
parameters. I just have to include it, and call the directives I
want.</p><p>There's nothing the library writer can do that would reduce the
possibilities of the user.</p></div></div><div class="step" step="19" data-x="4800" data-y="3600"><p>Higher order stuff: a directive to add directives</p><p>(with conflicts detection!)</p><pre class="highlight code python"><span class="c"># in pyramid_awesomeness.includeme</span>
<span class="k">def</span> <span class="nf">set_awesomeness_level</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
        <span class="n">config</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">awesomeness_level</span> <span class="o">=</span> <span class="n">level</span>
    <span class="n">discriminator</span> <span class="o">=</span> <span class="p">(</span><span class="s">'set_awesomeness_level'</span><span class="p">,)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s">'set_awesomeness_level'</span><span class="p">,</span> <span class="n">set_awesomeness_level</span><span class="p">)</span></pre><p>In my application:</p><pre class="highlight code python"><span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">'pyramid_awesomeness'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">set_awesomeness_level</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span></pre><div class="notes"><p>A directive consist of a directive that is discriminator that is
used to detect conflicts (two directive calls with the same
discriminator are in conflict), and a callback : the actual stuff
that is done.</p><p>Here, we have a directive to set the awesomeness level. It has
conflict detection.</p></div></div><div class="step" step="20" data-scale="3" data-x="-1800" data-y="2800"><h1 id="summary">Summary</h1><p>We have a system to delegate configuration and to check that
everything is sound.</p><p>A great way to organize the configuration of an application.</p><p>A great way to make libraries.</p><div class="notes"><p>You can put different parts of your app in different places and
include them all.</p><p>In the end, there is no difference between a modularized
application and a library : the exacts same tools are used.</p><p>Except that you have to find a name for the library (and write
documentation).</p></div></div><div class="step" step="21" data-scale="1" data-y="4400" data-x="-1800"><h1 id="meanwhile-using-django">Meanwhile, using django</h1><p>When you import something, you have to configure every hook by hand.</p><pre class="highlight code python"><span class="n">INSTALLED_APPS</span>
<span class="n">AUTHENTICATION_BACKENDS</span>
<span class="n">TEMPLATE_CONTEXT_PROCESSORS</span>
<span class="n">urls</span><span class="o">.</span><span class="n">py</span>
<span class="o">...</span></pre></div><div class="step" step="22" data-x="-200" data-y="4400" data-scale="1"><h1 id="so-what-can-i-do-with-all-this">So, what can I do with all this ?</h1><p>Tips, examples, recipes, ...</p><p>For applications and libraries</p></div><div class="step" step="23" data-x="1400" data-y="4400" data-scale="1"><h1 id="for-your-application">For your application</h1></div><div class="step" step="24" data-x="3000" data-y="4400" data-scale="1"><h1 id="using-add-directive-to-simplify-the-config">Using add_directive to simplify the config</h1><pre class="highlight code python"><span class="c"># A very simple application, with only one view per route</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'route1'</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view1</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'route1'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'route2'</span><span class="p">,</span> <span class="s">'/stuff'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view2</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'route2'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">'route3'</span><span class="p">,</span> <span class="s">'/otherstuff'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view3</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'route3'</span><span class="p">)</span>
<span class="c"># And so on</span></pre></div><div class="step" step="25" data-x="4600" data-y="4400" data-scale="1"><p>Transformed to:</p><pre class="highlight code python"><span class="k">def</span> <span class="nf">add_simple_view</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">callback</span><span class="p">():</span>
        <span class="n">route_name</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">__qualname__</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="n">route_name</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="n">route_name</span><span class="p">)</span>
    <span class="n">discriminator</span> <span class="o">=</span> <span class="p">(</span><span class="s">'add_simple_view'</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

<span class="n">config</span><span class="o">.</span><span class="n">add_directive</span><span class="p">(</span><span class="s">'add_simple_view'</span><span class="p">,</span> <span class="n">add_simple_view</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_simple_view</span><span class="p">(</span><span class="n">view1</span><span class="p">,</span> <span class="s">'/'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_simple_view</span><span class="p">(</span><span class="n">view2</span><span class="p">,</span> <span class="s">'/stuff'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_simple_view</span><span class="p">(</span><span class="n">view3</span><span class="p">,</span> <span class="s">'/otherstuff'</span><span class="p">)</span></pre></div><div class="step" step="26" data-x="6200" data-y="4400" data-scale="1"><h1 id="what-if-i-want-a-decorator">What if I want a decorator ?</h1><p>Use venusian decorators, they are detected by config.scan()</p><pre class="highlight code python"><span class="k">class</span> <span class="nc">simple_view</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="n">scanner</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_simple_view</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">):</span>
        <span class="n">venusian</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">wrapped</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wrapped</span>

<span class="nd">@simple_view</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">'It is I, Arthur, son of Uther Pendragon, ...'</span><span class="p">)</span></pre></div><div class="step" step="27" data-x="7800" data-y="4400" data-scale="1"><h1 id="adding-methods-to-request">Adding methods to request</h1><p>It'd be nice if request.user was the user object for the current user.</p><pre class="highlight code python"><span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">authenticated_userid</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">DBSession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>


<span class="n">config</span><span class="o">.</span><span class="n">add_request_method</span><span class="p">(</span><span class="n">get_user</span><span class="p">,</span> <span class="s">'user'</span><span class="p">,</span> <span class="n">reify</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre><p>Reified means the method is replaced by the object after the first call.</p></div><div class="step" step="28" data-x="9400" data-y="4400" data-scale="1"><h1 id="events">Events</h1><p>Pyramid has an event system.</p><pre class="highlight code python"><span class="nd">@subscriber</span><span class="p">(</span><span class="n">EventClass</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">pass</span></pre><ul><li>BeforeRender to add globals to the templates</li><li>NewRequest, NewResponse when a request/response is created</li><li>ContextFound when traversal is done</li><li>ApplicationCreated</li></ul></div><div class="step" step="29" data-x="11000" data-y="4400" data-scale="1"><h1 id="adding-globals-to-the-templates">Adding globals to the templates</h1><pre class="highlight code python"><span class="nd">@subscriber</span><span class="p">(</span><span class="n">BeforeRender</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_helper</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">helpers</span>
    <span class="n">event</span><span class="p">[</span><span class="s">'h'</span><span class="p">]</span> <span class="o">=</span> <span class="n">helpers</span></pre><p>In my template:</p><pre class="highlight code mako"><span class="cp">${</span><span class="n">h</span><span class="o">.</span><span class="n">format_date</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="cp">}</span></pre></div><div class="step" step="30" data-x="12600" data-y="4400" data-scale="1"><h1 id="a-lot-of-other-things-can-be-changed">A lot of other things can be changed</h1><ul><li>How url are generated</li><li>How view responses are handled</li><li>How requests are mapped to views</li><li>Sessions, authentication, renderers</li></ul></div><div class="step" step="31" data-x="14200" data-y="4400" data-scale="1"><h1 id="libraries">Libraries</h1><div class="notes"><p>All of the above is still usable</p></div></div><div class="step" step="32" data-x="15800" data-y="4400" data-scale="1"><h1 id="more-globals-to-templates">More globals to templates</h1><pre class="highlight code python"><span class="nd">@subscriber</span><span class="p">(</span><span class="n">BeforeRender</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_renderer_global</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="p">[</span><span class="s">'persona_js'</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_persona_js</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
    <span class="c"># persona_js is available in the template</span></pre></div><div class="step" step="33" data-x="17400" data-y="4400" data-scale="1"><h1 id="using-add-directive-to-add-an-entry-point">Using add_directive to add an entry point</h1><p>pyramid_layout extends pyramid with layouts and panels.</p><p>To the user, it is seamless.</p><pre class="highlight code python"><span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">'pyramid_layout'</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_layout</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_panel</span><span class="p">(</span><span class="o">...</span><span class="p">)</span></pre><div class="notes"><p>add_directive is used in library to add new configuration
directives for the user.</p><p>Once added, they are no different from pyramid's directives.</p></div></div><div class="step" step="34" data-x="19000" data-y="4400" data-scale="1"><h1 id="add-view-predicate">add_view_predicate</h1><pre class="highlight code python"><span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">,</span>
                      <span class="n">request_method</span><span class="o">=</span><span class="s">'POST'</span><span class="p">)</span>
<span class="c"># route_name and request_method are view predicates</span></pre><p>Used to decide whether a request matches a view.</p><p>Can also do extra work before the view is executed.</p></div><div class="step" step="35" data-x="20600" data-y="4400" data-scale="1"><p>Example in pyramid_layout</p><pre class="highlight code python"><span class="k">class</span> <span class="nc">LayoutPredicate</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">'layout = </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>

    <span class="n">phash</span> <span class="o">=</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">layout_manager</span><span class="o">.</span><span class="n">use_layout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="c"># In the includeme</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view_predicate</span><span class="p">(</span><span class="s">'layout'</span><span class="p">,</span> <span class="n">LayoutPredicate</span><span class="p">)</span>

<span class="c"># In user's code</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_view</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">route_name</span><span class="o">=</span><span class="s">'hello'</span><span class="p">,</span>
                      <span class="n">layout</span><span class="o">=</span><span class="s">'some_layout'</span><span class="p">)</span></pre></div><div class="step" step="36" data-x="22200" data-y="4400" data-scale="1"><h1 id="tweens">Tweens</h1><p>Some code around pyramid's request handling.</p><p>Used by pyramid_debugtoolbar and pyramid_exclog to catch exceptions in
the application.</p></div><div class="step" step="37" data-x="23800" data-y="4400" data-scale="1"><h1 id="how-to-handle-global-stuff">How to handle global stuff</h1><p>Global stuff like database connections, ...</p><ul><li>registry (config.registry and request.registry)</li><li>in the settings dict</li></ul><div class="notes"><p>Two clans</p></div></div><div class="step" step="38" data-x="25400" data-y="4400" data-scale="1"><h1 id="building-upon-pyramid">Building upon pyramid</h1><p>Example : cornice</p><pre class="highlight code">user_info = Service(name='users', path='/{username}/info',
                    description=info_desc)

@user_info.get()
def get_info(request):
    username = request.matchdict['username']
    return _USERS[username]

@user_info.post()
def set_info(request):
    ...</pre><div class="notes"><p>Raise the right errors with other methods, documentation,
validation, Content-Type</p></div></div><div class="step" step="39" data-x="27000" data-y="4400" data-scale="1"><ul><li>config.add_cornice_service</li><li>venusian callback attached to Service, so service is caught by config.scan</li></ul></div><div class="step" step="40" data-x="28600" data-y="4400" data-scale="1"><h1 id="conclusion">Conclusion</h1><div class="notes"><p>That's it.</p><p>Pyramid is really customizatible. If one day, you need something
that doesn't fit the django way, think about this.</p></div></div><div class="step" step="41" data-x="30200" data-y="4400" data-scale="1"><h1 id="references">References</h1><ul><li><a href="http://docs.pylonsproject.org/projects/pyramid_cookbook/en/latest/configuration/whirlwind_tour.html">http://docs.pylonsproject.org/projects/pyramid_cookbook/en/latest/configuration/whirlwind_tour.html</a></li><li><a href="http://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/advconfig.html">http://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/advconfig.html</a></li><li><a href="http://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/hooks.html">http://docs.pylonsproject.org/projects/pyramid/en/1.4-branch/narr/hooks.html</a></li></ul><div class="notes"><p>Parts of this presentation were heavily inspired by the
documentation and the cookbook</p></div></div><div class="step" step="42" data-x="31800" data-y="4400" data-scale="1"><h1 id="thanks">Thanks</h1><p>@georgesdubus</p><p>madjar.github.io/europython2013</p></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Left, Down, Page Down</th><td>Next slide</td></tr><tr><th>Right, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script></body></html>